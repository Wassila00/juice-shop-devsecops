# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
name: "CodeQL Advanced"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '22 16 * * 4'

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: javascript-typescript
          build-mode: none

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}

    - name: Run manual build steps
      if: matrix.build-mode == 'manual'
      shell: bash
      run: |
        echo 'Add build commands here if needed'
        exit 1

    # ✅ Perform CodeQL Analysis (SARIF output only, do NOT auto-upload)
    - name: Perform CodeQL Analysis (SARIF output only)
      id: codeql
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{ matrix.language }}"
        upload: false
        output: codeql-results-${{ matrix.language }}.sarif

    # ✅ Convert SARIF to HTML Report
    - name: Convert SARIF to HTML report
      uses: actions/github-script@v7
      env:
        MATRIX_LANGUAGE: ${{ matrix.language }}
      with:
        script: |
          const fs = require('fs');
          const sarifFile = `codeql-results-${process.env.MATRIX_LANGUAGE}.sarif`;
          const sarif = JSON.parse(fs.readFileSync(sarifFile, 'utf8'));
          const results = sarif.runs[0].results || [];
          const rows = results.map(r => {
            const rule = r.ruleId || 'N/A';
            const msg = r.message?.text || '';
            const file = r.locations?.[0]?.physicalLocation?.artifactLocation?.uri || 'N/A';
            const line = r.locations?.[0]?.physicalLocation?.region?.startLine || '';
            const sev = r.properties?.['security-severity'] || 'N/A';
            return `<tr><td>${rule}</td><td>${msg}</td><td>${file}</td><td>${line}</td><td>${sev}</td></tr>`;
          }).join('');
          const html = `
            <html>
            <head><meta charset="utf-8"><title>CodeQL Report</title></head>
            <body>
            <h1>CodeQL Security Report - ${process.env.MATRIX_LANGUAGE}</h1>
            <table border="1">
              <tr>
                <th>Rule</th><th>Description</th><th>File</th><th>Line</th><th>Severity</th>
              </tr>
              ${rows}
            </table>
            </body>
            </html>
          `;
          fs.writeFileSync(`codeql-report-${process.env.MATRIX_LANGUAGE}.html`, html);

    # ✅ Upload HTML + SARIF report as workflow artifact
    - name: Upload CodeQL Reports
      uses: actions/upload-artifact@v4
      with:
        name: codeql-${{ matrix.language }}-report
        path: |
          codeql-results-${{ matrix.language }}.sarif
          codeql-report-${{ matrix.language }}.html
