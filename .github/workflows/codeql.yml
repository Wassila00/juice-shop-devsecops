name: CodeQL Analysis

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript', 'typescript' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}

    - name: Autobuild
      uses: github/codeql-action/autobuild@v3

    # ✅ Analyse + export SARIF
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{ matrix.language }}"
        output: codeql-results-${{ matrix.language }}.sarif

    # ✅ Conversion SARIF → HTML Rapport lisible
    - name: Convert SARIF to HTML Report
      uses: actions/github-script@v7
      env:
        MATRIX_LANGUAGE: ${{ matrix.language }}
      with:
        script: |
          const fs = require('fs');
          const sarifPath = `codeql-results-${process.env.MATRIX_LANGUAGE}.sarif`;
          const sarif = JSON.parse(fs.readFileSync(sarifPath, 'utf8'));
          const findings = sarif.runs[0].results;

          const rows = findings.map(f => {
            const rule = f.ruleId || 'N/A';
            const desc = (f.message.text || '').replace(/</g, '&lt;');
            const file = f.locations?.[0]?.physicalLocation?.artifactLocation?.uri || 'N/A';
            const line = f.locations?.[0]?.physicalLocation?.region?.startLine || '-';
            const sev = f.properties?.['security-severity'] || 'N/A';
            return `<tr><td>${rule}</td><td>${desc}</td><td>${file}</td><td>${line}</td><td>${sev}</td></tr>`;
          }).join('');

          const html = `
            <html>
            <head>
              <meta charset="utf-8">
              <title>CodeQL Report - ${process.env.MATRIX_LANGUAGE}</title>
              <style>
                body { font-family: Arial; padding: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; }
                th { background: #000; color: #fff; }
              </style>
            </head>
            <body>
              <h1>CodeQL Security Report (${process.env.MATRIX_LANGUAGE})</h1>
              <table>
                <tr><th>Rule</th><th>Description</th><th>File</th><th>Line</th><th>Severity</th></tr>
                ${rows}
              </table>
            </body>
            </html>`;
          fs.writeFileSync(`codeql-report-${process.env.MATRIX_LANGUAGE}.html`, html);

    # ✅ Upload SARIF + HTML en artifact téléchargeable
    - name: Upload CodeQL Reports
      uses: actions/upload-artifact@v4
      with:
        name: codeql-${{ matrix.language }}-report
        path: |
          codeql-results-${{ matrix.language }}.sarif
          codeql-report-${{ matrix.language }}.html
